<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Portfolio Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root{
            --bg:#0a0e13;
            --panel:#0d1117;
            --panel-secondary:#161b22;
            --border:rgba(48,54,61,0.6);
            --border-hover:rgba(48,54,61,0.9);
            --text:#e6edf3;
            --text-secondary:#8b949e;
            --muted:#6e7681;
            --accent:#58a6ff;
            --positive:#3fb950;
            --negative:#f85149;
            --warning:#d29922;
            --info:#58a6ff;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: var(--text);
            font-size: 14px;
            line-height: 1.5;
        }

        /* Top header bar */
        .header-bar {
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
        }
        .header-bar h1 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            color: var(--text);
            letter-spacing: -0.02em;
        }
        .header-stats {
            display: flex;
            gap: 24px;
            font-size: 12px;
        }
        .header-stat {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .header-stat-label {
            color: var(--muted);
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.05em;
        }
        .header-stat-value {
            font-weight: 600;
            font-size: 14px;
            font-variant-numeric: tabular-nums;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--bg);
            padding: 16px 20px;
            position: relative;
        }

        h2 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            margin: 0 0 12px 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        h3 {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 0 0 12px 0;
        }

        /* Dashboard Cards - Financial style */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .card {
            background: var(--panel);
            padding: 14px 16px;
            border-radius: 6px;
            border: 1px solid var(--border);
            transition: border-color 0.2s ease;
        }
        
        .card:hover {
            border-color: var(--border-hover);
        }

        .card h3 {
            font-size: 11px;
            color: var(--muted);
            margin: 0 0 8px 0;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 500;
        }

        .card .value {
            font-size: 24px;
            font-weight: 600;
            color: var(--text);
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.02em;
            line-height: 1;
        }
        
        .card .change {
            font-size: 12px;
            margin-top: 6px;
            font-variant-numeric: tabular-nums;
        }

        .card.positive .value { color: var(--positive); }
        .card.negative .value { color: var(--negative); }

        /* Form Section */
        .form-section {
            background: var(--panel);
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 12px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 4px;
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-group input,
        .form-group select {
            padding: 8px 10px;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: var(--panel-secondary);
            color: var(--text);
            font-size: 13px;
            transition: all 0.15s ease;
            font-variant-numeric: tabular-nums;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--panel);
            box-shadow: 0 0 0 3px rgba(88,166,255,0.1);
        }

        .form-group input::placeholder {
            color: var(--muted);
            font-size: 12px;
        }

        .form-group select option { background: var(--panel); color: var(--text); }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 7px 14px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--panel-secondary);
            color: var(--text);
        }
        
        button:hover {
            background: var(--panel);
            border-color: var(--border-hover);
        }

        .btn-primary { 
            background: var(--accent); 
            color: #fff; 
            border-color: var(--accent);
        }

        .btn-primary:hover { 
            background: #4493f8;
            border-color: #4493f8;
        }

        .btn-success { 
            background: var(--positive); 
            color: #fff;
            border-color: var(--positive);
        }

        .btn-success:hover { 
            background: #46b955;
            border-color: #46b955;
        }

        .btn-danger { 
            background: var(--negative); 
            color: #fff;
            border-color: var(--negative);
        }

        .btn-danger:hover { 
            background: #f97066;
            border-color: #f97066;
        }

        .btn-secondary { 
            background: transparent; 
            color: var(--text-secondary); 
            border: 1px solid var(--border);
        }

        .btn-secondary:hover { 
            background: var(--panel-secondary);
            color: var(--text);
        }

        /* Table Section - Financial terminal style */
        .table-section { 
            background: var(--panel); 
            padding: 0; 
            border-radius: 6px; 
            margin-bottom: 16px; 
            overflow: auto; 
            border: 1px solid var(--border);
        }
        
        .table-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--panel);
            z-index: 11;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead { 
            background: var(--panel-secondary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
        }
        
        th:first-child { padding-left: 16px; }
        th:last-child { padding-right: 16px; }

        td { 
            padding: 10px 12px; 
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            font-variant-numeric: tabular-nums;
        }
        
        td:first-child { padding-left: 16px; }
        td:last-child { padding-right: 16px; }

        tbody tr:hover { background: var(--panel-secondary); }
        tbody tr:last-child td { border-bottom: none; }

        .profit { color: var(--positive); font-weight: 600; }
        .loss { color: var(--negative); font-weight: 600; }
        
        .ticker-cell {
            font-weight: 600;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .action-btn { 
            padding: 4px 8px; 
            font-size: 11px; 
            margin: 0 2px;
        }
        
        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .chart-container { 
            background: var(--panel); 
            padding: 16px; 
            border-radius: 6px; 
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            aspect-ratio: 9 / 10; /* slightly taller than square to show bottom labels */
            position: relative;
            overflow: hidden;
        }

        .chart-container h3 {
            margin: 0 0 12px 0;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
            display: block;
        }

        /* Empty State */
        .empty-state { text-align: center; padding: 40px 10px; color: var(--muted); }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            h1 {
                font-size: 1.4rem;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            /* Charts: 1 column and compact height on mobile */
            .charts-section { grid-template-columns: 1fr; gap: 10px; }
            .chart-container { aspect-ratio: auto; height: 240px; padding: 8px; }
            .chart-container h3 { font-size: 10px; margin-bottom: 6px; }

            table { font-size: 0.9rem; }
            th, td { padding: 10px 8px; }
        }

        @media (max-width: 1200px) {
            .charts-section { grid-template-columns: repeat(2, 1fr); }
        }

        /* Mobile table -> cards */
        @media (max-width: 720px){
            thead { display: none; }
            table, tbody, tr, td { display: block; width: 100%; }
            tr { margin-bottom: 12px; border: 1px solid var(--border); border-radius: 10px; background: #0b1220; overflow: hidden; }
            td { border: none; border-bottom: 1px solid rgba(255,255,255,0.06); display: grid; grid-template-columns: 120px 1fr; gap: 8px; padding: 10px 12px; }
            td:last-child { border-bottom: none; }
            td::before { content: attr(data-label); color: var(--muted); font-size: 0.8rem; }
            .action-btn { padding: 8px 10px; }
        }

        /* Floating Add Button (mobile) */
        .fab{
            position: fixed;
            right: 18px;
            bottom: calc(env(safe-area-inset-bottom, 0px) + 18px);
            width: 52px; height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: #fff; border: none;
            font-size: 28px; line-height: 0;
            display: none; align-items: center; justify-content: center;
            box-shadow: 0 10px 25px rgba(59,130,246,0.35);
            cursor: pointer;
            z-index: 50;
        }
        @media (max-width: 900px){ .fab{ display: inline-flex; } }

        /* Minimal: no extra animations */
    </style>
</head>
<body>
    <!-- Top Header Bar -->
    <div class="header-bar">
        <h1>üíº Portfolio Tracker</h1>
        <div class="header-stats">
            <div class="header-stat">
                <span class="header-stat-label">Portfolio Value</span>
                <span class="header-stat-value" id="headerValue">$0.00</span>
            </div>
            <div class="header-stat">
                <span class="header-stat-label">24h Change</span>
                <span class="header-stat-value" id="headerChange">+$0.00</span>
            </div>
            <div class="header-stat">
                <span class="header-stat-label">Total Return</span>
                <span class="header-stat-value" id="headerReturn">0%</span>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Dashboard Cards -->
        <div class="dashboard">
            <div class="card">
                <h3>–û–±—â–∞—è —Å—É–º–º–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π</h3>
                <div class="value" id="totalInvested">$0.00</div>
            </div>
            <div class="card">
                <h3>–¢–µ–∫—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</h3>
                <div class="value" id="currentValue">$0.00</div>
            </div>
            <div class="card" id="profitCard">
                <h3>–ü—Ä–∏–±—ã–ª—å / –£–±—ã—Ç–æ–∫</h3>
                <div class="value" id="totalProfit">$0.00</div>
            </div>
            <div class="card">
                <h3>ROI</h3>
                <div class="value" id="roi">0%</div>
            </div>
        </div>

        <!-- Add Investment Form -->
        <div class="form-section" id="addForm">
            <h2>–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤</h2>
            <form id="investmentForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>–¢–∏–∫–µ—Ä (—Ç–æ—á–Ω—ã–π, A‚ÄìZ 0‚Äì9 . - =) *</label>
                        <input type="text" id="assetName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: AAPL, BRK-B, 700.HK, BTC –∏–ª–∏ BTC-USD" required pattern="[A-Z0-9.\-=]+" title="–¢–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª—ã A‚ÄìZ, 0‚Äì9, —Ç–æ—á–∫–∞, –¥–µ—Ñ–∏—Å, —Ä–∞–≤–Ω–æ; –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤. –î–ª—è –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç –º–æ–∂–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª (BTC=BTC-USD)">
                    </div>
                    <div class="form-group">
                        <label>–¢–∏–ø –∞–∫—Ç–∏–≤–∞ *</label>
                        <select id="assetType" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                            <option value="–ê–∫—Ü–∏–∏">–ê–∫—Ü–∏–∏</option>
                            <option value="–û–±–ª–∏–≥–∞—Ü–∏–∏">–û–±–ª–∏–≥–∞—Ü–∏–∏</option>
                            <option value="–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞">–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞</option>
                            <option value="ETF">ETF</option>
                            <option value="–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å">–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</option>
                            <option value="–î—Ä–∞–≥–æ—Ü–µ–Ω–Ω—ã–µ –º–µ—Ç–∞–ª–ª—ã">–î—Ä–∞–≥–æ—Ü–µ–Ω–Ω—ã–µ –º–µ—Ç–∞–ª–ª—ã</option>
                            <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
                        <input type="number" id="quantity" step="0.0001" placeholder="0" required>
                    </div>
                    <div class="form-group">
                        <label>–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏ ($) *</label>
                        <input type="number" id="buyPrice" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ ($) *</label>
                        <input type="number" id="currentPrice" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label>–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏ *</label>
                        <input type="date" id="buyDate" required>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button type="button" class="btn-secondary" onclick="clearForm()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
            </form>
        </div>

        <!-- Investments Table -->
        <div class="table-section">
            <div class="table-header">
                <h2>Holdings</h2>
                <div class="btn-group">
                    <button class="btn-secondary" onclick="configureApiKeys()">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    <button class="btn-primary" onclick="updatePricesFromMarkets()">–û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—ã</button>
                    <button class="btn-secondary" onclick="cloudMenu()">–û–±–ª–∞–∫–æ</button>
                    <button class="btn-success" onclick="exportToCSV()">Export CSV</button>
                    <button class="btn-secondary" onclick="exportToJSON()">Save</button>
                    <button class="btn-secondary" onclick="document.getElementById('importFile').click()">Load</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importFromJSON(event)">
                    <button class="btn-danger" onclick="clearAllData()">Clear</button>
                </div>
            </div>
            <div id="tableContainer">
                <div class="empty-state">
                    <h3>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
                    <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –∞–∫—Ç–∏–≤, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —É—á—ë—Ç</p>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-section">
            <div class="chart-container">
                <h3>–ö—Ä–∏–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ –ø—Ä–æ—Å–∞–¥–∫–∞</h3>
                <canvas id="equityChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º</h3>
                <canvas id="allocationChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>P/L –ø–æ –∞–∫—Ç–∏–≤–∞–º</h3>
                <canvas id="plChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ vs –¢–µ–∫—É—â–∞—è (–ø–æ —Ç–∏–ø–∞–º)</h3>
                <canvas id="typeCompareChart"></canvas>
            </div>
        </div>

    </div>

    <!-- Floating Add Button (mobile) -->
    <button class="fab" aria-label="–î–æ–±–∞–≤–∏—Ç—å" onclick="document.getElementById('addForm').scrollIntoView({behavior:'smooth'});">+</button>

    <script>

    // Utility: Format currency with thousands separator
    function formatCurrency(value) {
        return value.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    // Portfolio history (for equity curve)
    let portfolioHistory = [];

    function loadHistory(){
        const saved = localStorage.getItem('portfolioHistory');
        if(saved){
            try { portfolioHistory = JSON.parse(saved); }
            catch { portfolioHistory = []; }
        }
    }

    function saveHistory(){
        try { localStorage.setItem('portfolioHistory', JSON.stringify(portfolioHistory)); } catch {}
    }

    function computeTotals(){
        let totalInvested = 0, currentValue = 0;
        investments.forEach(inv => {
            totalInvested += inv.quantity * inv.buyPrice;
            currentValue += inv.quantity * inv.currentPrice;
        });
        return { totalInvested, currentValue };
    }

    function recordSnapshot(){
        const { totalInvested, currentValue } = computeTotals();
        const day = new Date().toISOString().slice(0,10);
        const last = portfolioHistory[portfolioHistory.length-1];
        if(!last || last.date !== day){
            portfolioHistory.push({ date: day, invested: totalInvested, value: currentValue });
            // keep last 365 entries
            if(portfolioHistory.length > 365) portfolioHistory = portfolioHistory.slice(-365);
            saveHistory();
        } else {
            // update today's value
            last.invested = totalInvested; last.value = currentValue; saveHistory();
        }
    }

    function updateCharts(){
        const isMobile = window.matchMedia('(max-width: 768px)').matches;
        // EQUITY + DRAWDOWN
        const labels = portfolioHistory.map(p => p.date);
        const values = portfolioHistory.map(p => p.value);
        // compute drawdown in %
        let peak = 0; const drawdowns = values.map(v => { peak = Math.max(peak, v); return peak ? ((v/peak)-1)*100 : 0; });

        const equityCtx = document.getElementById('equityChart').getContext('2d');
        if (equityChart) equityChart.destroy();
        equityChart = new Chart(equityCtx, {
            type: 'line',
            data: {
                labels,
                datasets: [
                    {
                        label: 'Value $',
                        data: values,
                        borderColor: '#58a6ff',
                        backgroundColor: 'rgba(88,166,255,0.15)',
                        tension: 0.25,
                        borderWidth: 2,
                        fill: false,
                        yAxisID: 'y1'
                    },
                    {
                        label: 'Drawdown %',
                        data: drawdowns,
                        borderColor: 'rgba(248,81,73,0.9)',
                        backgroundColor: 'rgba(248,81,73,0.15)',
                        tension: 0.25,
                        borderWidth: 1,
                        fill: true,
                        yAxisID: 'y2'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                layout: { padding: { top: 4, right: 4, bottom: 12, left: 4 } },
                scales: {
                    y1: {
                        position: 'left',
                        ticks: { color: '#cbd5e1', callback: v => '$' + Number(v).toLocaleString('en-US'), font: { size: isMobile ? 9 : 12 } },
                        grid: { color: 'rgba(148,163,184,0.15)' }
                    },
                    y2: {
                        position: 'right',
                        ticks: { color: '#cbd5e1', callback: v => v + '%', font: { size: isMobile ? 9 : 12 } },
                        grid: { display: false },
                        suggestedMin: -100, suggestedMax: 0
                    },
                    x: { ticks: { color: '#cbd5e1', font: { size: isMobile ? 9 : 12 }, maxTicksLimit: isMobile ? 4 : 10 }, grid: { color: 'rgba(148,163,184,0.08)' } }
                },
                plugins: { legend: { display: !isMobile, labels: { color: '#cbd5e1', font: { size: isMobile ? 9 : 12 } } } }
            }
        });

        // ALLOCATION BY TYPE (DONUT)
        const typeGroups = {};
        investments.forEach(inv => { const val = inv.quantity * inv.currentPrice; typeGroups[inv.type] = (typeGroups[inv.type]||0)+val; });
        const allocCtx = document.getElementById('allocationChart').getContext('2d');
        if (allocationChart) allocationChart.destroy();
        allocationChart = new Chart(allocCtx, {
            type: 'doughnut',
            data: { labels: Object.keys(typeGroups), datasets: [{ data: Object.values(typeGroups), backgroundColor: ['#58a6ff','#8b949e','#3fb950','#d29922','#f85149','#06b6d4','#a78bfa','#94a3b8'], borderWidth: 0 }] },
            options: { maintainAspectRatio: false, layout: { padding: { top: 4, right: 4, bottom: 12, left: 4 } }, plugins: { legend: { display: !isMobile, position: 'bottom', labels: { color: '#cbd5e1', font: { size: isMobile ? 9 : 12 } } } } }
        });

        // P/L BY ASSET (HORIZONTAL)
        const plData = investments.map(inv => { const invested = inv.quantity * inv.buyPrice; const current = inv.quantity * inv.currentPrice; return { name: inv.name, pl: current - invested }; }).sort((a,b)=>a.pl-b.pl);
        const plCtx = document.getElementById('plChart').getContext('2d');
        if (plChart) plChart.destroy();
        plChart = new Chart(plCtx, {
            type: 'bar',
            data: { labels: plData.map(d=>d.name), datasets: [{ label: 'P/L $', data: plData.map(d=>d.pl), backgroundColor: plData.map(d=> d.pl>=0 ? 'rgba(63,185,80,0.9)' : 'rgba(248,81,73,0.9)') }] },
            options: { indexAxis: 'y', maintainAspectRatio: false, layout: { padding: { top: 4, right: 4, bottom: 12, left: 4 } }, plugins: { legend: { display: !isMobile, labels: { color: '#cbd5e1', font: { size: isMobile ? 9 : 12 } } } }, scales: { x: { ticks: { color: '#cbd5e1', callback: v => '$' + Number(v).toLocaleString('en-US'), font: { size: isMobile ? 9 : 12 } }, grid:{ color: 'rgba(148,163,184,0.15)' } }, y: { ticks:{ color: '#cbd5e1', font: { size: isMobile ? 9 : 12 } }, grid:{ color:'rgba(148,163,184,0.08)'} } } }
        });

        // INVESTED vs CURRENT BY TYPE (STACKED)
        const agg = {};
        investments.forEach(inv=>{ const invested = inv.quantity*inv.buyPrice; const current = inv.quantity*inv.currentPrice; if(!agg[inv.type]) agg[inv.type] = { invested: 0, current: 0 }; agg[inv.type].invested += invested; agg[inv.type].current += current; });
        const labelsType = Object.keys(agg);
        const investedArr = labelsType.map(k=>agg[k].invested);
        const currentArr = labelsType.map(k=>agg[k].current);
        const typeCtx = document.getElementById('typeCompareChart').getContext('2d');
        if (typeCompareChart) typeCompareChart.destroy();
        typeCompareChart = new Chart(typeCtx, {
            type: 'bar',
            data: { labels: labelsType, datasets: [ { label: '–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ', data: investedArr, backgroundColor: 'rgba(148,163,184,0.9)' }, { label: '–¢–µ–∫—É—â–∞—è', data: currentArr, backgroundColor: 'rgba(88,166,255,0.9)' } ] },
            options: { plugins: { legend: { display: !isMobile, labels: { color: '#cbd5e1', font: { size: isMobile ? 9 : 12 } } } }, responsive: true, maintainAspectRatio: false, layout: { padding: { top: 4, right: 4, bottom: 12, left: 4 } }, scales: { x: { stacked: true, ticks:{ color:'#cbd5e1', font: { size: isMobile ? 9 : 12 } }, grid:{ color:'rgba(148,163,184,0.08)' } }, y: { stacked: true, ticks:{ color:'#cbd5e1', callback: v => '$' + Number(v).toLocaleString('en-US'), font: { size: isMobile ? 9 : 12 } }, grid:{ color:'rgba(148,163,184,0.15)' } } } }
        });
    }

    // Fetch current prices from public APIs using exact tickers
    async function fetchCoinbaseSpot(pair){
        // pair example: BTC-USD, ETH-EUR
        const url = `https://api.coinbase.com/v2/prices/${encodeURIComponent(pair)}/spot`;
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if(!res.ok) throw new Error(`Coinbase ${pair} ${res.status}`);
        const json = await res.json();
        const amt = json && json.data && json.data.amount ? Number(json.data.amount) : NaN;
        if(Number.isNaN(amt)) throw new Error('Invalid price');
        return amt;
    }

    async function fetchAlphaVantagePrice(symbol){
        const apiKey = localStorage.getItem('ALPHAVANTAGE_API_KEY');
        if(!apiKey) throw new Error('NO_ALPHA_KEY');
        const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${encodeURIComponent(symbol)}&apikey=${encodeURIComponent(apiKey)}`;
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if(!res.ok) throw new Error(`AlphaVantage ${symbol} ${res.status}`);
        const json = await res.json();
        const quote = json && (json['Global Quote'] || json['global quote']);
        const priceStr = quote && (quote['05. price'] || quote['05. Price']);
        const price = priceStr ? Number(priceStr) : NaN;
        if(Number.isNaN(price)) throw new Error('Invalid price');
        return price;
    }

    const delay = (ms) => new Promise(r => setTimeout(r, ms));

    function getAlphaKey(){
        return localStorage.getItem('ALPHAVANTAGE_API_KEY') || '';
    }
    function setAlphaKey(key){
        if(key && key.trim()){
            localStorage.setItem('ALPHAVANTAGE_API_KEY', key.trim());
            return true;
        }
        return false;
    }
    function clearAlphaKey(){ localStorage.removeItem('ALPHAVANTAGE_API_KEY'); }

    function configureApiKeys(){
        const current = getAlphaKey();
        const input = prompt('–í–≤–µ–¥–∏—Ç–µ Alpha Vantage API Key (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º —á—Ç–æ–±—ã –æ—á–∏—Å—Ç–∏—Ç—å):', current);
        if(input === null) return; // cancelled
        if(input.trim() === '') { clearAlphaKey(); alert('–ö–ª—é—á —É–¥–∞–ª—ë–Ω. –ê–∫—Ü–∏–∏/ETF –Ω–µ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è.'); return; }
        if(setAlphaKey(input)){
            alert('–ö–ª—é—á —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—ã (–∞–∫—Ü–∏–∏/ETF).');
        }
    }

    async function updatePricesFromMarkets(opts = {}){
        const silent = !!opts.silent;
        const btn = !silent ? document.querySelector('.table-header .btn-group .btn-primary') : null;
        const original = btn ? btn.textContent : '';
        if(btn) btn.textContent = '–û–±–Ω–æ–≤–ª—è—é‚Ä¶';

        let updated = 0, failed = 0;

        // Build list with unique tickers by type
        // Crypto: allow either full pair (BTC-USD) or single token (BTC -> BTC-USD)
        const cryptoNames = Array.from(new Set(investments.filter(i => i.type === '–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞').map(i => i.name)));
        const defaultQuote = (localStorage.getItem('CRYPTO_DEFAULT_QUOTE') || 'USD').toUpperCase();
        const pairByName = {};
        cryptoNames.forEach(name => {
            const trimmed = (name || '').toUpperCase().trim();
            if (/^[A-Z0-9]+-[A-Z]{3,5}$/.test(trimmed)) {
                pairByName[name] = trimmed;
            } else if (/^[A-Z0-9]{2,15}$/.test(trimmed)) {
                pairByName[name] = `${trimmed}-${defaultQuote}`;
            } else {
                pairByName[name] = null; // invalid format
            }
        });
        const equitySymbols = Array.from(new Set(investments.filter(i => i.type !== '–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞').map(i => i.name)));

        // Update crypto first
        for(const name of cryptoNames){
            try {
                const pair = pairByName[name];
                if(!pair || !/^[A-Z0-9]+-[A-Z]{3,5}$/.test(pair)) { failed++; continue; }
                const price = await fetchCoinbaseSpot(pair);
                if(Number.isFinite(price)) {
                    investments.forEach(inv => { if(inv.type === '–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞' && inv.name === name) inv.currentPrice = price; });
                    updated++;
                }
            } catch (e){ failed++; }
        }

        // Update stocks/ETF/others via Alpha Vantage if key is present
    const hasAlpha = !!getAlphaKey();
        if(hasAlpha){
            for(const sym of equitySymbols){
                try {
                    if(!/^[A-Z0-9.\-=]{1,15}$/.test(sym)) { failed++; continue; }
                    const price = await fetchAlphaVantagePrice(sym);
                    if(Number.isFinite(price)) {
                        investments.forEach(inv => { if(inv.name === sym) inv.currentPrice = price; });
                        updated++;
                    }
                    // throttle to respect free tier
                    await delay(1500);
                } catch (e){ failed++; }
            }
        }

        saveData();
        recordSnapshot();
        renderTable();
        updateDashboard();
        updateCharts();

        if(btn) {
            if(updated === 0){
                // Provide hints
                if(equitySymbols.length > 0 && !hasAlpha){
                    btn.textContent = '–ù—É–∂–µ–Ω API –∫–ª—é—á –¥–ª—è –∞–∫—Ü–∏–π';
                } else if(cryptoNames.length > 0){
                    btn.textContent = '–ö—Ä–∏–ø—Ç–æ: –º–æ–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å BTC (USD –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)';
                } else {
                    btn.textContent = '–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ç–∏–∫–µ—Ä–æ–≤';
                }
            } else {
                btn.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${updated}`;
            }
            setTimeout(()=>{ btn.textContent = original || '–û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—ã'; }, 2000);
        }
    }

    // --- Cloud sync via GitHub Gist ---
    function getGistToken(){ return localStorage.getItem('GIST_TOKEN') || ''; }
    function setGistToken(t){ if(t && t.trim()){ localStorage.setItem('GIST_TOKEN', t.trim()); return true; } return false; }
    function clearGistToken(){ localStorage.removeItem('GIST_TOKEN'); }
    function getGistId(){ return localStorage.getItem('GIST_ID') || ''; }
    function setGistId(id){ if(id && id.trim()){ localStorage.setItem('GIST_ID', id.trim()); return true; } return false; }
    function clearGistId(){ localStorage.removeItem('GIST_ID'); }

    function cloudMenu(){
        const choice = prompt(
            '–û–±–ª–∞–∫–æ (GitHub Gist):\n'+
            '1 ‚Äî –ó–∞–¥–∞—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω\n'+
            '2 ‚Äî –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ\n'+
            '3 ‚Äî –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞\n'+
            '4 ‚Äî –°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏',
            '2'
        );
        if(choice === null) return;
        if(choice === '1') return configureGistToken();
        if(choice === '2') return saveToCloud();
        if(choice === '3') return loadFromCloud();
        if(choice === '4') { clearGistToken(); clearGistId(); alert('–°–±—Ä–æ—à–µ–Ω–æ.'); return; }
        alert('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞');
    }

    function configureGistToken(){
        alert('–ù—É–∂–µ–Ω GitHub Personal Access Token —Å –ø—Ä–∞–≤–æ–º "gist". –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è Fine-grained token —Ç–æ–ª—å–∫–æ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ gist.');
        const current = getGistToken();
        const input = prompt('–í—Å—Ç–∞–≤—å—Ç–µ GitHub Token (gist scope). –ü—É—Å—Ç–æ = —É–¥–∞–ª–∏—Ç—å:', current);
        if(input === null) return;
        if(!input.trim()){ clearGistToken(); alert('–¢–æ–∫–µ–Ω —É–¥–∞–ª—ë–Ω'); return; }
        if(setGistToken(input)) alert('–¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω.');
    }

    function buildCloudPayload(){
        return JSON.stringify({
            version: 1,
            updatedAt: new Date().toISOString(),
            investments,
            portfolioHistory
        }, null, 2);
    }

    async function saveToCloud(){
        const token = getGistToken();
        if(!token){ alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–π—Ç–µ —Ç–æ–∫–µ–Ω (–û–±–ª–∞–∫–æ ‚Üí 1).'); return; }
        const gistId = getGistId();
        const body = { files: { 'portfolio.json': { content: buildCloudPayload() } }, description: 'Portfolio Tracker data', public: false };
        const headers = { 'Accept': 'application/vnd.github+json', 'Authorization': `token ${token}` };
        try{
            let res;
            if(gistId){
                res = await fetch(`https://api.github.com/gists/${encodeURIComponent(gistId)}`, { method: 'PATCH', headers, body: JSON.stringify({ files: body.files }) });
            } else {
                res = await fetch('https://api.github.com/gists', { method: 'POST', headers, body: JSON.stringify(body) });
            }
            if(!res.ok) throw new Error(`${res.status}`);
            const json = await res.json();
            if(json && json.id) setGistId(json.id);
            alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –æ–±–ª–∞–∫–æ');
        } catch(e){
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –æ–±–ª–∞–∫–æ: ' + e.message);
        }
    }

    async function loadFromCloud(){
        const token = getGistToken();
        if(!token){ alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–π—Ç–µ —Ç–æ–∫–µ–Ω (–û–±–ª–∞–∫–æ ‚Üí 1).'); return; }
        let gistId = getGistId();
        if(!gistId){
            gistId = prompt('–í–≤–µ–¥–∏—Ç–µ ID Gist (–µ—Å–ª–∏ —É–∂–µ —Å–æ–∑–¥–∞–≤–∞–ª–∏). –ò–Ω–∞—á–µ –æ—Ç–º–µ–Ω–∏—Ç–µ –∏ —Å–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –≤ –æ–±–ª–∞–∫–æ.','');
            if(gistId) setGistId(gistId);
        }
        if(!gistId) return;
        try{
            const headers = { 'Accept': 'application/vnd.github+json', 'Authorization': `token ${token}` };
            const res = await fetch(`https://api.github.com/gists/${encodeURIComponent(gistId)}`, { headers });
            if(!res.ok) throw new Error(`${res.status}`);
            const gist = await res.json();
            const file = gist && gist.files && (gist.files['portfolio.json'] || Object.values(gist.files)[0]);
            if(!file) throw new Error('–§–∞–π–ª portfolio.json –Ω–µ –Ω–∞–π–¥–µ–Ω');
            const rawRes = await fetch(file.raw_url);
            const text = await rawRes.text();
            const data = JSON.parse(text);
            if(Array.isArray(data)){
                investments = data; // legacy support
            } else {
                if(Array.isArray(data.investments)) investments = data.investments;
                if(Array.isArray(data.portfolioHistory)) portfolioHistory = data.portfolioHistory;
            }
            saveData();
            saveHistory();
            renderTable();
            updateDashboard();
            updateCharts();
            alert('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –æ–±–ª–∞–∫–∞');
        } catch(e){
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –æ–±–ª–∞–∫–∞: ' + e.message);
        }
    }

    // Data Storage
    let investments = [];
    let editingId = null; // current editing investment id or null
    
    // Chart instances
    let equityChart = null;
    let allocationChart = null;
    let plChart = null;
    let typeCompareChart = null;

        // Load data from localStorage
        function loadData() {
            const saved = localStorage.getItem('investments');
            if (saved) {
                try {
                    investments = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading data:', e);
                }
            }
            loadHistory();
            renderTable();
            updateDashboard();
            recordSnapshot();
            updateCharts();
        }

        // Save data to localStorage
        function saveData() {
            try {
                localStorage.setItem('investments', JSON.stringify(investments));
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: ' + e.message);
            }
        }
        // Initialize date field
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('buyDate');
            dateInput.value = new Date().toISOString().split('T')[0];

            // Enforce uppercase and allowed characters for ticker (A‚ÄìZ 0‚Äì9 . - =)
            const tickerInput = document.getElementById('assetName');
            tickerInput.addEventListener('input', () => {
                tickerInput.value = tickerInput.value
                    .toUpperCase()
                    .replace(/[^A-Z0-9.\-=]/g, '');
            });

            loadData();
            // First background price sync (silent)
            updatePricesFromMarkets({ silent: true }).catch(()=>{});
            // Auto-refresh every 5 minutes
            window.__priceTimer = setInterval(() => {
                updatePricesFromMarkets({ silent: true }).catch(()=>{});
            }, 5 * 60 * 1000);
        });

        // Form submission
        document.getElementById('investmentForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const investment = {
                name: document.getElementById('assetName').value.trim(),
                type: document.getElementById('assetType').value,
                quantity: parseFloat(document.getElementById('quantity').value),
                buyPrice: parseFloat(document.getElementById('buyPrice').value),
                currentPrice: parseFloat(document.getElementById('currentPrice').value),
                buyDate: document.getElementById('buyDate').value,
                addedDate: new Date().toISOString()
            };

            if (editingId !== null) {
                // Update existing investment
                const idx = investments.findIndex(i => i.id === editingId);
                if (idx !== -1) {
                    investments[idx] = { ...investments[idx], ...investment, id: editingId };
                }
            } else {
                // Add new investment
                investment.id = Date.now();
                investments.push(investment);
            }
            saveData();
            recordSnapshot();
            renderTable();
            updateDashboard();
            updateCharts();
            clearForm();

            // Success feedback
            const btn = document.querySelector('.btn-primary');
            const originalText = btn.innerHTML;
            btn.innerHTML = (editingId === null ? '–î–æ–±–∞–≤–ª–µ–Ω–æ' : '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);

            // Reset editing state
            editingId = null;
            document.querySelector('.btn-primary').textContent = '–î–æ–±–∞–≤–∏—Ç—å';
        });

        // Clear form
        function clearForm() {
            document.getElementById('investmentForm').reset();
            document.getElementById('buyDate').value = new Date().toISOString().split('T')[0];
            editingId = null;
            const btn = document.querySelector('.btn-primary');
            if (btn) btn.textContent = '–î–æ–±–∞–≤–∏—Ç—å';
        }

        // Render table
        function renderTable() {
            const container = document.getElementById('tableContainer');

            if (investments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
                        <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –∞–∫—Ç–∏–≤, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —É—á—ë—Ç</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>–¢–∏–∫–µ—Ä</th>
                            <th>–¢–∏–ø</th>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                            <th>–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏</th>
                            <th>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞</th>
                            <th>–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ</th>
                            <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                            <th>–ü—Ä–∏–±—ã–ª—å/–£–±—ã—Ç–æ–∫</th>
                            <th>ROI</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            investments.forEach(inv => {
                const invested = inv.quantity * inv.buyPrice;
                const currentVal = inv.quantity * inv.currentPrice;
                const profitLoss = currentVal - invested;
                const roi = ((profitLoss / invested) * 100).toFixed(2);
                const profitClass = profitLoss >= 0 ? 'profit' : 'loss';
                const sign = profitLoss >= 0 ? '+' : '';

                html += `
                    <tr>
                        <td data-label="–¢–∏–∫–µ—Ä" class="ticker-cell"><strong>${inv.name}</strong></td>
                        <td data-label="–¢–∏–ø">${inv.type}</td>
                        <td data-label="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">${inv.quantity.toLocaleString()}</td>
                        <td data-label="–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏">$${formatCurrency(inv.buyPrice)}</td>
                        <td data-label="–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞">$${formatCurrency(inv.currentPrice)}</td>
                        <td data-label="–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ">$${formatCurrency(invested)}</td>
                        <td data-label="–°—Ç–æ–∏–º–æ—Å—Ç—å">$${formatCurrency(currentVal)}</td>
                        <td data-label="–ü—Ä–∏–±—ã–ª—å/–£–±—ã—Ç–æ–∫" class="${profitClass}">${sign}$${formatCurrency(Math.abs(profitLoss))}</td>
                        <td data-label="ROI" class="${profitClass}">${sign}${roi}%</td>
                        <td data-label="–î–∞—Ç–∞">${new Date(inv.buyDate).toLocaleDateString()}</td>
                        <td data-label="–î–µ–π—Å—Ç–≤–∏—è">
                            <button class="btn-secondary action-btn" onclick="editInvestment(${inv.id})">–ò–∑–º.</button>
                            <button class="btn-danger action-btn" onclick="deleteInvestment(${inv.id})">–£–¥–∞–ª.</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Update dashboard
        function updateDashboard() {
            let totalInvested = 0;
            let currentValue = 0;

            investments.forEach(inv => {
                totalInvested += inv.quantity * inv.buyPrice;
                currentValue += inv.quantity * inv.currentPrice;
            });

            const totalProfit = currentValue - totalInvested;
            const roiPercent = totalInvested > 0 ? ((totalProfit / totalInvested) * 100).toFixed(2) : 0;

            document.getElementById('totalInvested').textContent = `$${formatCurrency(totalInvested)}`;
            document.getElementById('currentValue').textContent = `$${formatCurrency(currentValue)}`;
            document.getElementById('totalProfit').textContent = `${totalProfit >= 0 ? '+' : ''}$${formatCurrency(Math.abs(totalProfit))}`;
            document.getElementById('roi').textContent = `${totalProfit >= 0 ? '+' : ''}${roiPercent}%`;

            // Update header bar stats
            document.getElementById('headerValue').textContent = `$${formatCurrency(currentValue)}`;
            document.getElementById('headerChange').textContent = `${totalProfit >= 0 ? '+' : ''}$${formatCurrency(Math.abs(totalProfit))}`;
            document.getElementById('headerReturn').textContent = `${totalProfit >= 0 ? '+' : ''}${roiPercent}%`;
            document.getElementById('headerChange').style.color = totalProfit >= 0 ? 'var(--positive)' : 'var(--negative)';
            document.getElementById('headerReturn').style.color = totalProfit >= 0 ? 'var(--positive)' : 'var(--negative)';

            const profitCard = document.getElementById('profitCard');
            if (totalProfit >= 0) {
                profitCard.classList.add('positive');
                profitCard.classList.remove('negative');
            } else {
                profitCard.classList.add('negative');
                profitCard.classList.remove('positive');
            }
        }

    // Charts removed

        // Edit investment
        function editInvestment(id) {
            const inv = investments.find(i => i.id === id);
            if (!inv) return;

            document.getElementById('assetName').value = inv.name;
            document.getElementById('assetType').value = inv.type;
            document.getElementById('quantity').value = inv.quantity;
            document.getElementById('buyPrice').value = inv.buyPrice;
            document.getElementById('currentPrice').value = inv.currentPrice;
            document.getElementById('buyDate').value = inv.buyDate;
            
            // Enter edit mode (do NOT delete immediately)
            editingId = id;
            const btn = document.querySelector('.btn-primary');
            if (btn) btn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Delete investment
        function deleteInvestment(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∞–∫—Ç–∏–≤?')) {
                investments = investments.filter(i => i.id !== id);
                saveData();
                recordSnapshot();
                renderTable();
                updateDashboard();
                updateCharts();
            }
        }

        // Clear all data
        function clearAllData() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')) {
                if (confirm('–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                    investments = [];
                    portfolioHistory = [];
                    saveData();
                    saveHistory();
                    renderTable();
                    updateDashboard();
                    if (equityChart) { equityChart.destroy(); equityChart = null; }
                    if (allocationChart) { allocationChart.destroy(); allocationChart = null; }
                    if (plChart) { plChart.destroy(); plChart = null; }
                    if (typeCompareChart) { typeCompareChart.destroy(); typeCompareChart = null; }
                }
            }
        }

        // Export to CSV
        function exportToCSV() {
            if (investments.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }

            let csv = '–¢–∏–∫–µ—Ä,–¢–∏–ø,–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ,–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏,–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞,–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ,–°—Ç–æ–∏–º–æ—Å—Ç—å,–ü—Ä–∏–±—ã–ª—å/–£–±—ã—Ç–æ–∫,ROI%,–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏\n';
            
            investments.forEach(inv => {
                const invested = inv.quantity * inv.buyPrice;
                const currentVal = inv.quantity * inv.currentPrice;
                const profitLoss = currentVal - invested;
                const roi = ((profitLoss / invested) * 100).toFixed(2);

                csv += `"${inv.name}","${inv.type}",${inv.quantity},${inv.buyPrice},${inv.currentPrice},${invested.toFixed(2)},${currentVal.toFixed(2)},${profitLoss.toFixed(2)},${roi},"${inv.buyDate}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `portfolio_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Export to JSON
        function exportToJSON() {
            if (investments.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }

            const blob = new Blob([JSON.stringify(investments, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `portfolio_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // Import from JSON
        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        if (confirm(`–ó–∞–≥—Ä—É–∑–∏—Ç—å ${data.length} –∞–∫—Ç–∏–≤–æ–≤? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã.`)) {
                            investments = data;
                            saveData();
                            recordSnapshot();
                            renderTable();
                            updateDashboard();
                            updateCharts();
                            alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!');
                        }
                    } else {
                        alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                    }
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }
    </script>
</body>
</html>
